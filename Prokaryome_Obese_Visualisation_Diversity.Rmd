---
title: "Obese_MetaPhlan"
author: "Catherine Purse"
date: "2024-08-02"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

* Load libraries
```{r}
library(phyloseq)
library(tidyverse)
library(microbiome)
library(grafify)
library(microViz)
library(patchwork)
```

* Function to create Phyloseq object from Metaphlan profile (https://rdrr.io/github/g-antonello/gautils2/src/R/metaphlan_to_phyloseq.R)
```{r}
metaphlan_to_phyloseq <- function(mpa,
                                  metadata = NULL,
                                  version = 4,
                                  verbose = TRUE,
                                  tax_lvl = "Species"){


  if(version == 4){
    if(is.character(mpa)){
      # load raw metaphlan data
      mpa <- data.table::fread(mpa) %>%
        as.data.frame()
    }
  }
    if(version == 3){
      if(is.character(mpa)){
        # load raw metaphlan data
        mpa <- data.table::fread(mpa,skip = 1) %>%
          as.data.frame()
      }
    }
  # find for each row, to which depth of taxonomy it arrives (as integers)
  tax_lengths <- mpa$clade_name %>%
    strsplit("|", fixed = T) %>%
    sapply(length)
  # remove first element,we want to keep it
  tax_lengths <- tax_lengths[-1]
  # get integer equivalent of the taxonomic level we want
  tax_lvl_int <- match(tax_lvl, c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "SGB"))
  # subset the otu table, so to keep only UNASSIGNED on top and the rows exactly to te taxonomic level
  otu_cleaned <- mpa[c(T, tax_lengths == tax_lvl_int), 2:ncol(mpa)]

  if(!is.null(metadata)){
    inters_names <- intersect(colnames(otu_cleaned), rownames(metadata))
    if(verbose){
      if(length(colnames(otu_cleaned)[!(colnames(otu_cleaned) %in% inters_names)])!= 0){
        cat("Metaphlan table samples lost: ")
        cat(colnames(otu_cleaned)[!(colnames(otu_cleaned) %in% inters_names)], sep = " ")
        cat("\n")
        cat("\n")
      }

      if(length(rownames(metadata)[!(rownames(metadata) %in% inters_names)]) != 0){
        cat("Metadata table samples lost: ")
        cat(rownames(metadata)[!(rownames(metadata) %in% inters_names)], sep = " ")
        cat("\n")
        cat("\n")
      }
    }

    otu_cleaned <- otu_cleaned[, inters_names]
    metadata_cleaned <- metadata[match(inters_names, rownames(metadata)),]

  }

  # create taxonomy table, filling empty columns with NA

  taxonomy_tab <- mpa[c(T, tax_lengths == tax_lvl_int), 1] %>%
    as.data.frame() %>%
    set_names("clade_name") %>%
    separate(col="clade_name", into = c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "SGB")[1:tax_lvl_int],sep = "\\|", fill = "right") %>%
    as.matrix()
  # rename the UNKNOWN clade as all unknown, otherwise we can't assign rownames
  taxonomy_tab[1,] <- rep("UNKNOWN",tax_lvl_int)

  #assign rownames to the tax level chosen
  rownames(taxonomy_tab) <- paste0("otu", seq_len(nrow(otu_cleaned)))
  rownames(otu_cleaned) <- rownames(taxonomy_tab)
  


    profiles <- phyloseq(otu_table(as.matrix(otu_cleaned), taxa_are_rows = TRUE),
                         tax_table(taxonomy_tab),
                         sample_data(metadata_cleaned, errorIfNULL = FALSE)
    )

    return(profiles)
}
```

* Load data
```{r}
#load metadata and reassign column 1 as rownames
metadata <- read_csv("ObeseMetadata_6189_Batch2_020824.csv") %>% 
  remove_rownames %>% 
  column_to_rownames(var =  "sample")

mpa_withunknown <- read_csv("Obese_Faecal_merged_bugslist.csv", skip=1)

# Average duplicate samples from obese mother & daughter
M972 <- rowMeans(mpa_withunknown[ , c(2,3)], na.rm=TRUE)
M972H <- rowMeans(mpa_withunknown[ , c(4,5)], na.rm=TRUE)

mpa_withunknown$M972 <- M972
mpa_withunknown$M972H <- M972H
mpa_withunknown <- mpa_withunknown[, -(2:5)]
View(mpa_withunknown)
```

## Colour palette
```{r}
cb_palette <- c("#ee8866", "#77aadd","#d3d3d3","#FDF28E","#8ED29B","#bbccee", "#AFC30A","#cc99cc","#C1E49C","#dd7788", "#009E73")
```

# Community Composition

## Kingdom level

* Parse metaphlan data into phyloseq object
```{r}
kingdom_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Kingdom"
)
```

```{r}
kingdom_physeq <- kingdom_physeq %>% tax_fix()
```

* Remove the leading characters (e.g. p__)
```{r}
# view part of the tax table
phyloseq::tax_table(kingdom_physeq)

# replace _[A-Z] with ""
tax_table(kingdom_physeq)[, colnames(tax_table(kingdom_physeq))] <- gsub(tax_table(kingdom_physeq)[, colnames(tax_table(kingdom_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(kingdom_physeq)
```

```{r}
# Filter kingdom level phyloseq object to remove Eukaryotes
kingdom_physeq <- subset_taxa(kingdom_physeq, Kingdom!="Eukaryota")
kingdom_physeq <- subset_samples(kingdom_physeq, id!="BD566GDH" & id !="I150E")
```

* Kingdom level
```{r}
#TopNOTUs.King <- names(sort(taxa_sums(kingdom_physeq), TRUE)[1:10])
#king10   <- prune_taxa(TopNOTUs.King, kingdom_physeq)

plot_bar(kingdom_physeq, fill="Kingdom")
```

* Faceted bar chart - Kingdom
- ID is age-ranked
```{r}
# melt into df
king10.df <- psmelt(kingdom_physeq)

# remove underscores between words in Phylum column
king10.df$Kingdom <- gsub("_", " ", king10.df$Kingdom)

# make region a factor in the df (i.e. change order of facets in next step)
king10.df$type <- factor(king10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

#make age group a factor
king10.df$agegroup <- factor(king10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
king10.df <- king10.df[order(king10.df$age, king10.df$id), ]
king10.df$id <- factor(king10.df$id, levels = unique(king10.df$id))

# plot
king_plot <- ggplot(king10.df, aes(x = id, y = Abundance, fill = Kingdom)) +
  theme_light() +
  geom_col() +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=12, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=12),
        axis.title = element_text(size = 16, color = "black"),
        plot.title = element_text(face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=16),
        legend.title = element_text(size=18),
        legend.position = "right") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
king_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_Kingdom_RelAb_020824.tiff"), units="in", width=10, height=5, res=300)
plot(king_plot)
dev.off()
```

## Phylum level

* Parse metaphlan data into phyloseq object
```{r}
phylum_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Phylum"
)
```

* Clean tax table
```{r}
phylum_physeq <- phylum_physeq %>% tax_fix()

# view part of the tax table
phyloseq::tax_table(phylum_physeq)

# replace _[A-Z] with ""
tax_table(phylum_physeq)[, colnames(tax_table(phylum_physeq))] <- gsub(tax_table(phylum_physeq)[, colnames(tax_table(phylum_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(phylum_physeq)
```

* Filter phylum level phyloseq object to remove Eukaryotes & unwanted samples
Samples from BD566GDH and I150E were frozen faecal samples rather than frozen omnigene samples. The sample from BD566GDH was also sent at RT meaning the composition likely changed during that time 
```{r}
phylum_physeq <- subset_taxa(phylum_physeq, Phylum!="Eukaryota")
phylum_physeq <- subset_samples(phylum_physeq, id!="BD566GDH" & id !="I150E")
```

* Find top 10 taxa
```{r}
TopNOTUs.Phy <- names(sort(taxa_sums(phylum_physeq), TRUE)[2:11])
phy10   <- prune_taxa(TopNOTUs.Phy, phylum_physeq)
plot_bar(phy10, fill="Phylum")

# prune "empty" samples
phy10 <- prune_samples(sample_sums(phy10) > 0, phy10)
plot_bar(phy10, fill="Phylum")
```

* Plot faceted bar chart
```{r}
# melt into df
phy10.df <- psmelt(phy10)

# remove underscores between words in Phylum column
phy10.df$Phylum <- gsub("_", " ", phy10.df$Phylum)

# make region a factor in the df (i.e. change order of facets in next step)
phy10.df$type <- factor(phy10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

#make age group a factor
phy10.df$agegroup <- factor(phy10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
phy10.df <- phy10.df[order(phy10.df$age, phy10.df$id), ]
phy10.df$id <- factor(phy10.df$id, levels = unique(phy10.df$id))

# plot
phyl_plot <- ggplot(phy10.df, aes(x = id, y = Abundance, fill = Phylum)) +
  theme_light() +
  geom_col() +
  ggtitle("Phylum") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)") +
  guides(fill = guide_legend(nrow = 3))
phyl_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_Phylum_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(phyl_plot)
dev.off()
```


## Class level

* Parse metaphlan data into phyloseq object
```{r}
class_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Class"
)
```

* Clean tax table
```{r}
class_physeq <- class_physeq %>% tax_fix()

# view part of the tax table
phyloseq::tax_table(class_physeq)

# replace _[A-Z] with ""
tax_table(class_physeq)[, colnames(tax_table(class_physeq))] <- gsub(tax_table(class_physeq)[, colnames(tax_table(class_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(class_physeq)

```

* Filter phylum level phyloseq object to remove Eukaryotes
```{r}
class_physeq <- subset_taxa(class_physeq, Class!="Eukaryota")
class_physeq <- subset_samples(class_physeq, id!="BD566GDH" & id !="I150E")
```

* Find top 10 taxa
```{r}
TopNOTUs.Cla <- names(sort(taxa_sums(class_physeq), TRUE)[2:11])
cla10   <- prune_taxa(TopNOTUs.Cla, class_physeq)
plot_bar(cla10, fill="Class")

# prune "empty" samples
cla10 <- prune_samples(sample_sums(cla10) > 0, cla10)
plot_bar(cla10, fill="Class")

```

* Plot faceted bar chart
```{r}
# melt into df
cla10.df <- psmelt(cla10)

# remove underscores between words in Class column
cla10.df$Class <- gsub("_", " ", cla10.df$Class)

# make region a factor in the df (i.e. change order of facets in next step)
cla10.df$type <- factor(cla10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

#make age group a factor
cla10.df$agegroup <- factor(cla10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
cla10.df <- cla10.df[order(cla10.df$age, cla10.df$id), ]
cla10.df$id <- factor(cla10.df$id, levels = unique(cla10.df$id))

# plot
cla_plot <- ggplot(cla10.df, aes(x = id, y = Abundance, fill = Class)) +
  theme_light() +
  geom_col() +
  ggtitle("Class") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
cla_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_Class_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(cla_plot)
dev.off()
```

## Order level

* Parse metaphlan data into phyloseq object
```{r}
order_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Order"
)
```

* Clean tax table
```{r}
order_physeq <- order_physeq %>% tax_fix()

# view part of the tax table
phyloseq::tax_table(order_physeq)

# replace _[A-Z] with ""
tax_table(order_physeq)[, colnames(tax_table(order_physeq))] <- gsub(tax_table(order_physeq)[, colnames(tax_table(order_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(order_physeq)
```

* Filter phylum level phyloseq object to remove Eukaryotes
```{r}
order_physeq <- subset_taxa(order_physeq, Order!="Eukaryota")
order_physeq <- subset_samples(order_physeq, id!="BD566GDH" & id !="I150E")
```

* Find top 10 taxa
```{r}
TopNOTUs.Ord <- names(sort(taxa_sums(order_physeq), TRUE)[2:11])
ord10   <- prune_taxa(TopNOTUs.Ord, order_physeq)
plot_bar(ord10, fill="Order")

# prune "empty" samples
ord10 <- prune_samples(sample_sums(ord10) > 0, ord10)
plot_bar(ord10, fill="Order")
```

* Plot faceted bar chart
```{r}
# melt into df
ord10.df <- psmelt(ord10)

# remove underscores between words in Order column
ord10.df$Order <- gsub("_", " ", ord10.df$Order)

# make region a factor in the df (i.e. change order of facets in next step)
ord10.df$type <- factor(ord10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

#make age group a factor
ord10.df$agegroup <- factor(ord10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
ord10.df <- ord10.df[order(ord10.df$age, ord10.df$id), ]
ord10.df$id <- factor(ord10.df$id, levels = unique(ord10.df$id))

# plot
ord_plot <- ggplot(ord10.df, aes(x = id, y = Abundance, fill = Order)) +
  theme_light() +
  geom_col() +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  ggtitle("Order") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
ord_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_Order_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(ord_plot)
dev.off()
```


* Create patchwork and export
```{r}
Obese_Tax1 <- phyl_plot / cla_plot / ord_plot
Obese_Tax1

tiff(file.path(folder_path, "Obese_Tax1.tiff"), units="in", width=8.27, height=13, res=300)
plot(Obese_Tax1)
dev.off()
```

## Family level

* Parse metaphlan data into phyloseq object
```{r}
family_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Family"
)
```

* Clean tax table
```{r}
family_physeq <- family_physeq %>% tax_fix()

# view part of the tax table
phyloseq::tax_table(family_physeq)

# replace _[A-Z] with ""
tax_table(family_physeq)[, colnames(tax_table(family_physeq))] <- gsub(tax_table(family_physeq)[, colnames(tax_table(family_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(family_physeq)
```

* Filter phylum level phyloseq object to remove Eukaryotes
```{r}
family_physeq <- subset_taxa(family_physeq, Family!="Eukaryota")
family_physeq <- subset_samples(family_physeq, id!="BD566GDH" & id !="I150E")
```

* Find top 10 taxa
```{r}
TopNOTUs.Fam <- names(sort(taxa_sums(family_physeq), TRUE)[2:11])
fam10   <- prune_taxa(TopNOTUs.Fam, family_physeq)
plot_bar(fam10, fill="Family")

# prune "empty" samples
fam10 <- prune_samples(sample_sums(fam10) > 0, fam10)
plot_bar(fam10, fill="Family")
```

* Plot faceted bar chart
```{r}
# melt into df
fam10.df <- psmelt(fam10)

# remove underscores between words in Family column
fam10.df$Family <- gsub("_", " ", fam10.df$Family)

# make region a factor in the df (i.e. change order of facets in next step)
fam10.df$type <- factor(fam10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

#make age group a factor
fam10.df$agegroup <- factor(fam10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
fam10.df <- fam10.df[order(fam10.df$age, fam10.df$id), ]
fam10.df$id <- factor(fam10.df$id, levels = unique(fam10.df$id))

# plot
fam_plot <- ggplot(fam10.df, aes(x = id, y = Abundance, fill = Family)) +
  theme_light() +
  geom_col() +
  ggtitle("Family") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)") +
  guides(fill = guide_legend(nrow = 3))
fam_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_Family_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(fam_plot)
dev.off()
```

## Genus level

* Parse metaphlan data into phyloseq object
```{r}
genus_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Genus"
)
```

* Clean tax table
```{r}
genus_physeq <- genus_physeq %>% tax_fix()

# view part of the tax table
phyloseq::tax_table(genus_physeq)

# replace _[A-Z] with ""
tax_table(genus_physeq)[, colnames(tax_table(genus_physeq))] <- gsub(tax_table(genus_physeq)[, colnames(tax_table(genus_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(genus_physeq)
```

* Filter phylum level phyloseq object to remove Eukaryotes
```{r}
genus_physeq <- subset_taxa(genus_physeq, Genus!="Eukaryota")
genus_physeq <- subset_samples(genus_physeq, id!="BD566GDH" & id !="I150E")
```

* Find top 10 taxa
```{r}
TopNOTUs.Gen <- names(sort(taxa_sums(genus_physeq), TRUE)[2:11])
gen10   <- prune_taxa(TopNOTUs.Gen, genus_physeq)
plot_bar(gen10, fill="Genus")

# prune "empty" samples
gen10 <- prune_samples(sample_sums(gen10) > 0, gen10)
plot_bar(gen10, fill="Genus")
```

* Plot faceted bar chart
```{r}
# melt into df
gen10.df <- psmelt(gen10)

# remove underscores between words in Genus column
gen10.df$Genus <- gsub("_", " ", gen10.df$Genus)

# make region a factor in the df (i.e. change order of facets in next step)
gen10.df$type <- factor(gen10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

#make age group a factor
gen10.df$agegroup <- factor(gen10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
gen10.df <- gen10.df[order(gen10.df$age, gen10.df$id), ]
gen10.df$id <- factor(gen10.df$id, levels = unique(gen10.df$id))

# plot
gen_plot <- ggplot(gen10.df, aes(x = id, y = Abundance, fill = Genus)) +
  theme_light() +
  geom_col() +
  ggtitle("Genus") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
gen_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_Genus_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(gen_plot)
dev.off()
```

## Species level

* Parse metaphlan data into phyloseq object
```{r}
species_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Species"
)
```

* Clean tax table
```{r}
species_physeq <- species_physeq %>% tax_fix()

# view part of the tax table
phyloseq::tax_table(species_physeq)

# replace _[A-Z] with ""
tax_table(species_physeq)[, colnames(tax_table(species_physeq))] <- gsub(tax_table(species_physeq)[, colnames(tax_table(species_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(species_physeq)
```

* Filter phylum level phyloseq object to remove Eukaryotes
```{r}
species_physeq <- subset_taxa(species_physeq, Species!="Eukaryota")
species_physeq <- subset_samples(species_physeq, id!="BD566GDH" & id !="I150E")
```

* Find top 10 taxa
```{r}
TopNOTUs.Spe <- names(sort(taxa_sums(species_physeq), TRUE)[2:11])
spe10   <- prune_taxa(TopNOTUs.Spe, species_physeq)
plot_bar(spe10, fill="Species")

# prune "empty" samples
spe10 <- prune_samples(sample_sums(spe10) > 0, spe10)
plot_bar(spe10, fill="Species")
```

* Plot faceted bar chart
```{r}
# melt into df
spe10.df <- psmelt(spe10)

# remove underscores between words in Species column
spe10.df$Species <- gsub("_", " ", spe10.df$Species)

# make region a factor in the df (i.e. change order of facets in next step)
spe10.df$type <- factor(spe10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

#make age group a factor
spe10.df$agegroup <- factor(spe10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
spe10.df <- spe10.df[order(spe10.df$age, spe10.df$id), ]
spe10.df$id <- factor(spe10.df$id, levels = unique(spe10.df$id))

# plot
spe_plot <- ggplot(spe10.df, aes(x = id, y = Abundance, fill = Species)) +
  theme_light() +
  geom_col() +
  ggtitle("Species") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)") +
  guides(fill = guide_legend(nrow = 4))
spe_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_Sp_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(spe_plot)
dev.off()
```

* Create patchwork and export
```{r}
Obese_Tax2 <- fam_plot / gen_plot / spe_plot
Obese_Tax2

tiff(file.path(folder_path, "Obese_Tax2.tiff"), units="in", width=8.27, height=13, res=300)
plot(Obese_Tax2)
dev.off()
```

## Segatella sp.

* Filter so only Segatella sp are included
```{r}
# Filter phylum level phyloseq object to remove Eukaryotes
species_physeq.seg <- subset_taxa(species_physeq, Genus=="Segatella")

plot_bar(species_physeq.seg, fill="Species")
```

```{r}
# melt into df
species.seg.df <- psmelt(species_physeq.seg)

# remove underscores between words in Species column
species.seg.df$Species <- gsub("_", " ", species.seg.df$Species)

#make age group a factor
species.seg.df$agegroup <- factor(species.seg.df$agegroup, levels = c("Young", "Adult", "Aged"))

# make region a factor in the df (i.e. change order of facets in next step)
species.seg.df$type <- factor(species.seg.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
species.seg.df <- species.seg.df[order(species.seg.df$age, species.seg.df$id), ]
species.seg.df$id <- factor(species.seg.df$id, levels = unique(species.seg.df$id))

# Order the 'Species' factor levels so that UNKNOWN is last
species.seg.df$Species <- factor(species.seg.df$Species, levels = c(sort(unique(species.seg.df$Species[species.seg.df$Species != 'UNKNOWN'])), 'UNKNOWN'))

# find number of unique species
unique_counts_seg <- sapply(species.seg.df, n_distinct)
unique_counts_seg

# Remove OTUs with an abundance of 0.1 or less
species.seg.df <- filter(species.seg.df, Abundance > 0.1)

# plot
seg.species_plot <- ggplot(species.seg.df, aes(x = id, y = Abundance, fill = Species)) +
  theme_light() +
  geom_col() +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=12, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=12),
        axis.title = element_text(size = 16, color = "black"),
        plot.title = element_text(face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=16),
        legend.title = element_text(size=18),
        legend.position = "right") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
seg.species_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_SegatellaSp_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(seg.species_plot)
dev.off()
```

# Archaea

## Archaea - Phylum

* Parse metaphlan data into phyloseq object
```{r}
arch.phy_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Phylum"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.phy_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.phy_physeq)[, colnames(tax_table(arch.phy_physeq))] <- gsub(tax_table(arch.phy_physeq)[, colnames(tax_table(arch.phy_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.phy_physeq)[1:10]
```


```{r}
# Filter phylum level phyloseq object according to Archaea
PHYL.arch <- subset_taxa(arch.phy_physeq, Kingdom=="Archaea")
PHYL.arch <- subset_samples(PHYL.arch, id != "BD566GDH" & id != "I150E")
```

* Find top 10 OTUs
```{r}
TopNOTUs.Arch.Phylum <- names(sort(taxa_sums(PHYL.arch), TRUE)[1:10])
arch.phylum10   <- prune_taxa(TopNOTUs.Arch.Phylum, PHYL.arch)
# prune "empty" samples
arch.phylum10 <- prune_samples(sample_sums(arch.phylum10) > 0, arch.phylum10)
# plot bar
plot_bar(arch.phylum10, fill="Phylum")
```

## Archaea Phylum Rel. Abundance

```{r}
# melt into df
arch.phylum10.df <- psmelt(arch.phylum10)

# remove underscores between words in Phylum column
arch.phylum10.df$Phylum <- gsub("_", " ", arch.phylum10.df$Phylum)

# make region a factor in the df (i.e. change order of facets in next step)
arch.phylum10.df$type <- factor(arch.phylum10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.phylum10.df <- arch.phylum10.df[order(arch.phylum10.df$age, arch.phylum10.df$id), ]
arch.phylum10.df$id <- factor(arch.phylum10.df$id, levels = unique(arch.phylum10.df$id))

# Order the 'Phylum' factor levels so that UNKNOWN is last
arch.phylum10.df$Phylum <- factor(arch.phylum10.df$Phylum, levels = c(sort(unique(arch.phylum10.df$Phylum[arch.phylum10.df$Phylum != 'UNKNOWN'])), 'UNKNOWN'))

#make age group a factor
arch.phylum10.df$agegroup <- factor(arch.phylum10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# plot
arch.phylum_plot <- ggplot(arch.phylum10.df, aes(x = id, y = Abundance, fill = Phylum)) +
  theme_light() +
  geom_col() +
  ggtitle("Phylum") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.phylum_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_ArchPhylum_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(arch.phylum_plot)
dev.off()
```

## Archaea - Class

* Parse metaphlan data into phyloseq object
```{r}
arch.class_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Class"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.class_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.class_physeq)[, colnames(tax_table(arch.class_physeq))] <- gsub(tax_table(arch.class_physeq)[, colnames(tax_table(arch.class_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.class_physeq)[1:10]
```


```{r}
# Filter class level phyloseq object according to Archaea
CLASS.arch <- subset_taxa(arch.class_physeq, Kingdom=="Archaea")
CLASS.arch <- subset_samples(CLASS.arch, id != "BD566GDH" & id != "I150E")
```

* Find top 10 OTUs
```{r}
TopNOTUs.Arch.Class <- names(sort(taxa_sums(CLASS.arch), TRUE)[1:10])
arch.class10   <- prune_taxa(TopNOTUs.Arch.Class, CLASS.arch)
# prune "empty" samples
arch.class10 <- prune_samples(sample_sums(arch.class10) > 0, arch.class10)
# plot bar
plot_bar(arch.class10, fill="Class")
```

## Archaea Class Rel. Abundance

```{r}
# melt into df
arch.class10.df <- psmelt(arch.class10)

# remove underscores between words in Class column
arch.class10.df$Class <- gsub("_", " ", arch.class10.df$Class)

# make region a factor in the df (i.e. change order of facets in next step)
arch.class10.df$type <- factor(arch.class10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.class10.df <- arch.class10.df[order(arch.class10.df$age, arch.class10.df$id), ]
arch.class10.df$id <- factor(arch.class10.df$id, levels = unique(arch.class10.df$id))

# Order the 'Class' factor levels so that UNKNOWN is last
arch.class10.df$Class <- factor(arch.class10.df$Class, levels = c(sort(unique(arch.class10.df$Class[arch.class10.df$Class != 'UNKNOWN'])), 'UNKNOWN'))

#make age group a factor
arch.class10.df$agegroup <- factor(arch.class10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# plot
arch.class_plot <- ggplot(arch.class10.df, aes(x = id, y = Abundance, fill = Class)) +
  theme_light() +
  geom_col() +
  ggtitle("Class") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.class_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_ArchClass_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(arch.class_plot)
dev.off()
```


## Archaea - Order

* Parse metaphlan data into phyloseq object
```{r}
arch.order_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Order"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.order_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.order_physeq)[, colnames(tax_table(arch.order_physeq))] <- gsub(tax_table(arch.order_physeq)[, colnames(tax_table(arch.order_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.order_physeq)[1:10]
```


```{r}
# Filter order level phyloseq object according to Archaea
ORDER.arch <- subset_taxa(arch.order_physeq, Kingdom=="Archaea")
ORDER.arch <- subset_samples(ORDER.arch, id != "BD566GDH" & id != "I150E")
```

* Find top 10 OTUs
```{r}
TopNOTUs.Arch.Order <- names(sort(taxa_sums(ORDER.arch), TRUE)[1:10])
arch.order10   <- prune_taxa(TopNOTUs.Arch.Order, ORDER.arch)
# prune "empty" samples
arch.order10 <- prune_samples(sample_sums(arch.order10) > 0, arch.order10)
# plot bar
plot_bar(arch.order10, fill="Order")
```

## Archaea Order Rel. Abundance

```{r}
# melt into df
arch.order10.df <- psmelt(arch.order10)

# remove underscores between words in Order column
arch.order10.df$Order <- gsub("_", " ", arch.order10.df$Order)

# make region a factor in the df (i.e. change order of facets in next step)
arch.order10.df$type <- factor(arch.order10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.order10.df <- arch.order10.df[order(arch.order10.df$age, arch.order10.df$id), ]
arch.order10.df$id <- factor(arch.order10.df$id, levels = unique(arch.order10.df$id))

# Order the 'Order' factor levels so that UNKNOWN is last
arch.order10.df$Order <- factor(arch.order10.df$Order, levels = c(sort(unique(arch.order10.df$Order[arch.order10.df$Order != 'UNKNOWN'])), 'UNKNOWN'))

#make age group a factor
arch.order10.df$agegroup <- factor(arch.order10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# plot
arch.order_plot <- ggplot(arch.order10.df, aes(x = id, y = Abundance, fill = Order)) +
  theme_light() +
  geom_col() +
  ggtitle("Order") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.order_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_ArchOrder_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(arch.order_plot)
dev.off()
```

* Create patchwork and export
```{r}
Obese_Arch_Tax1 <- arch.phylum_plot / arch.class_plot / arch.order_plot
Obese_Arch_Tax1

tiff(file.path(temp_folder_path, "Obese_Arch_Tax1.tiff"), units="in", width=8.27, height=13, res=300)
plot(Obese_Arch_Tax1)
dev.off()
```

## Archaea - Family

* Parse metaphlan data into phyloseq object
```{r}
arch.family_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Family"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.family_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.family_physeq)[, colnames(tax_table(arch.family_physeq))] <- gsub(tax_table(arch.family_physeq)[, colnames(tax_table(arch.family_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.family_physeq)[1:10]
```


```{r}
# Filter family level phyloseq object according to Archaea
FAMILY.arch <- subset_taxa(arch.family_physeq, Kingdom=="Archaea")
FAMILY.arch <- subset_samples(FAMILY.arch, id != "BD566GDH" & id != "I150E")
```

* Find top 10 OTUs
```{r}
TopNOTUs.Arch.Family <- names(sort(taxa_sums(FAMILY.arch), TRUE)[1:10])
arch.family10   <- prune_taxa(TopNOTUs.Arch.Family, FAMILY.arch)
# prune "empty" samples
arch.family10 <- prune_samples(sample_sums(arch.family10) > 0, arch.family10)
# plot bar
plot_bar(arch.family10, fill="Family")
```

## Archaea Family Rel. Abundance

```{r}
# melt into df
arch.family10.df <- psmelt(arch.family10)

# remove underscores between words in Family column
arch.family10.df$Family <- gsub("_", " ", arch.family10.df$Family)

# make region a factor in the df (i.e. change order of facets in next step)
arch.family10.df$type <- factor(arch.family10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.family10.df <- arch.family10.df[order(arch.family10.df$age, arch.family10.df$id), ]
arch.family10.df$id <- factor(arch.family10.df$id, levels = unique(arch.family10.df$id))

# Order the 'Family' factor levels so that UNKNOWN is last
arch.family10.df$Family <- factor(arch.family10.df$Family, levels = c(sort(unique(arch.family10.df$Family[arch.family10.df$Family != 'UNKNOWN'])), 'UNKNOWN'))

#make age group a factor
arch.family10.df$agegroup <- factor(arch.family10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# plot
arch.family_plot <- ggplot(arch.family10.df, aes(x = id, y = Abundance, fill = Family)) +
  theme_light() +
  geom_col() +
  ggtitle("Family") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.family_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_ArchFamily_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(arch.family_plot)
dev.off()
```

## Archaea - Genus

* Parse metaphlan data into phyloseq object
```{r}
arch.genus_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Genus"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.genus_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.genus_physeq)[, colnames(tax_table(arch.genus_physeq))] <- gsub(tax_table(arch.genus_physeq)[, colnames(tax_table(arch.genus_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.genus_physeq)[1:10]
```


```{r}
# Filter genus level phyloseq object according to Archaea
GENUS.arch <- subset_taxa(arch.genus_physeq, Kingdom=="Archaea")
GENUS.arch <- subset_samples(GENUS.arch, id != "BD566GDH" & id != "I150E")
```

* Find top 10 OTUs
```{r}
TopNOTUs.Arch.Genus <- names(sort(taxa_sums(GENUS.arch), TRUE)[1:10])
arch.genus10   <- prune_taxa(TopNOTUs.Arch.Genus, GENUS.arch)
# prune "empty" samples
arch.genus10 <- prune_samples(sample_sums(arch.genus10) > 0, arch.genus10)
# plot bar
plot_bar(arch.genus10, fill="Genus")
```

## Archaea Genus Rel. Abundance

```{r}
# melt into df
arch.genus10.df <- psmelt(arch.genus10)

# remove underscores between words in Genus column
arch.genus10.df$Genus <- gsub("_", " ", arch.genus10.df$Genus)

# make region a factor in the df (i.e. change order of facets in next step)
arch.genus10.df$type <- factor(arch.genus10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.genus10.df <- arch.genus10.df[order(arch.genus10.df$age, arch.genus10.df$id), ]
arch.genus10.df$id <- factor(arch.genus10.df$id, levels = unique(arch.genus10.df$id))

# Order the 'Genus' factor levels so that UNKNOWN is last
arch.genus10.df$Genus <- factor(arch.genus10.df$Genus, levels = c(sort(unique(arch.genus10.df$Genus[arch.genus10.df$Genus != 'UNKNOWN'])), 'UNKNOWN'))

#make age group a factor
arch.genus10.df$agegroup <- factor(arch.genus10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# plot
arch.genus_plot <- ggplot(arch.genus10.df, aes(x = id, y = Abundance, fill = Genus)) +
  theme_light() +
  geom_col() +
  ggtitle("Genus") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.genus_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_ArchGenus_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(arch.genus_plot)
dev.off()
```

## Archaea - Species

* Parse metaphlan data into phyloseq object
```{r}
arch.species_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Species"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.species_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.species_physeq)[, colnames(tax_table(arch.species_physeq))] <- gsub(tax_table(arch.species_physeq)[, colnames(tax_table(arch.species_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.species_physeq)[1:10]
```


```{r}
# Filter species level phyloseq object according to Archaea
SPECIES.arch <- subset_taxa(arch.species_physeq, Kingdom=="Archaea")
SPECIES.arch <- subset_samples(SPECIES.arch, id != "BD566GDH" & id != "I150E")
```

* Find top 10 OTUs
```{r}
TopNOTUs.Arch.Species <- names(sort(taxa_sums(SPECIES.arch), TRUE)[1:10])
arch.species10   <- prune_taxa(TopNOTUs.Arch.Species, SPECIES.arch)
# prune "empty" samples
arch.species10 <- prune_samples(sample_sums(arch.species10) > 0, arch.species10)
# plot bar
plot_bar(arch.species10, fill="Species")
```

## Archaea Species Rel. Abundance

```{r}
# melt into df
arch.species10.df <- psmelt(arch.species10)

# remove underscores between words in Species column
arch.species10.df$Species <- gsub("_", " ", arch.species10.df$Species)

# make region a factor in the df (i.e. change order of facets in next step)
arch.species10.df$type <- factor(arch.species10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.species10.df <- arch.species10.df[order(arch.species10.df$age, arch.species10.df$id), ]
arch.species10.df$id <- factor(arch.species10.df$id, levels = unique(arch.species10.df$id))

# Order the 'Species' factor levels so that UNKNOWN is last
arch.species10.df$Species <- factor(arch.species10.df$Species, levels = c(sort(unique(arch.species10.df$Species[arch.species10.df$Species != 'UNKNOWN'])), 'UNKNOWN'))

#make age group a factor
arch.species10.df$agegroup <- factor(arch.species10.df$agegroup, levels = c("Young", "Adult", "Aged"))

# plot
arch.species_plot <- ggplot(arch.species10.df, aes(x = id, y = Abundance, fill = Species)) +
  theme_light() +
  geom_col() +
  ggtitle("Species") +
  facet_grid(~ agegroup, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)") + 
  guides(fill = guide_legend(nrow = 3))  # Adjust the number as needed
arch.species_plot
```

# Save plot
```{r}
tiff(file.path(folder_path, "Obese_ArchSpecies_RelAb.tiff"), units="in", width=10, height=5, res=300)
plot(arch.species_plot)
dev.off()
```

* Create patchwork and export
```{r}
Obese_Arch_Tax2 <- arch.family_plot / arch.genus_plot / arch.species_plot
Obese_Arch_Tax2

tiff(file.path(temp_folder_path, "Obese_Arch_Tax2.tiff"), units="in", width=8.5, height=13, res=300)
plot(Obese_Arch_Tax2)
dev.off()
```


# Alpha and beta diversity

* Parse metaphlan data into phyloseq object
```{r}
species_physeq.noEuk <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Species"
)
```

* Filter so only bacteria and archaea are included
```{r}
# Filter phylum level phyloseq object to remove Eukaryotes
species_physeq.noEuk <- subset_taxa(species_physeq.noEuk, Kingdom!="Eukaryota")
species_physeq.noEuk <- subset_samples(species_physeq.noEuk, id != "BD566GDH" & id != "I150E")
```

* Plot ordination
```{r}
## Reorder Region and Age Group factor levels
# Get sample data from the phyloseq object
sample_data_df <- as.data.frame(sample_data(species_physeq.noEuk))


# Reorder factor levels - Age Group
sample_data_df$agegroup <- factor(sample_data_df$agegroup, levels=c("Adult", "Aged"))

# Update the sample data in the phyloseq object
sample_data(species_physeq.noEuk) <- sample_data(sample_data_df)



mpa.ord <- ordinate(species_physeq.noEuk, "NMDS", "bray")
mpa.ord.plot <- plot_ordination(species_physeq.noEuk, mpa.ord, type="samples", color="healthstatus", shape = "agegroup") +
  theme_bw() +
  scale_shape_discrete(name = "Age Group") +
  theme(text = element_text(size = 15)) +
  geom_point(size = 4) +
  scale_color_manual(name = "Region", values = cb_palette)
print(mpa.ord.plot)
```


## Alpha diversity by obesity status
Not enough samples to compare alpha diversity by age group
```{r}
tab <- microbiome::alpha(species_physeq.noEuk, index = "all")
head(tab)
#remove empty taxa
D.species = filter_taxa(species_physeq.noEuk, function(x) mean(x) > 0, TRUE)


#chao1
chao <- boxplot_alpha(species_physeq.noEuk,
                          index = "chao1",
                          x_var = "healthstatus",
                          )

p.chao <- chao +
  theme_bw() +
  labs(x="Health Status", y="Chao1") +
    theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        legend.text = element_text(size=12),
        legend.title = element_text(size=16),
        legend.position ='none') +
  scale_fill_manual(name = "Region", values = cb_palette)
p.chao

#inverse simpson
simpson <- boxplot_alpha(species_physeq.noEuk,
                          index = "inverse_simpson",
                          x_var = "healthstatus",
                          )

p.simpson <- simpson +
  theme_bw() +
  labs(x="Health Status", y="Inverse Simpson") +
    theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        legend.text = element_text(size=12),
        legend.title = element_text(size=16),
        legend.position ='none') +
  scale_fill_manual(name = "Region", values = cb_palette)
p.simpson


# shannon diversity

shannon <- boxplot_alpha(species_physeq.noEuk, 
                           index = "shannon",
                           x_var = "healthstatus",
                           )


p.shannon <- shannon +
  theme_bw() +
  labs(x="Health Status", y="Shannon") +
    theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        legend.text = element_text(size=12),
        legend.title = element_text(size=16),
        legend.position ='none') +
  scale_fill_manual(name = "Region", values = cb_palette)
p.shannon

```

* Save as 300 dpi tiff
```{r}
alpha_patchwork <- p.chao / p.simpson / p.shannon +
   plot_layout(guides = "collect", axis_titles = "collect")
alpha_patchwork

# Save ordination plot
tiff(file.path(folder_path, "Ob_BetaDiv_Ordination_030824.tiff"), units="in", width=6, height=4.6, res=300)
plot(mpa.ord.plot)
dev.off()

# Save alpha diversity
tiff(file.path(folder_path, "Ob_AlphaDiv_Patchwork_030824.tiff"), units="in", width=5, height=7.5, res=300)
plot(alpha_patchwork)
dev.off()
```

* Create patchwork and export
```{r}
Obese_AlphaDiversity <- (p.observed + p.chao) / 
  (p.simpson + p.shannon) #/ 
  #mpa.ord.plot +
  #patchwork::plot_layout(widths = c(1, 2))
Obese_AlphaDiversity

tiff(file.path(folder_path, "Obese_AlphaDiversity.tiff"), units="in", width=10, height=10, res=300)
plot(Obese_AlphaDiversity)
dev.off()
```

