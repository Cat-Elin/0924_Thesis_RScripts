---
title: "Prokaryome: Visualisation"
author: "Catherine Purse"
date: "2024-07-25"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


* Load libraries
```{r}
# Load libraries
library(phyloseq)
library(tidyverse)
library(microbiome)
library(grafify)
library(microViz)
library(patchwork)
library(nlme)
```

* Function to create Phyloseq object from Metaphlan profile (https://rdrr.io/github/g-antonello/gautils2/src/R/metaphlan_to_phyloseq.R)
```{r}
metaphlan_to_phyloseq <- function(mpa,
                                  metadata = NULL,
                                  version = 4,
                                  verbose = TRUE,
                                  tax_lvl = "Species"){


  if(version == 4){
    if(is.character(mpa)){
      # load raw metaphlan data
      mpa <- data.table::fread(mpa) %>%
        as.data.frame()
    }
  }
    if(version == 3){
      if(is.character(mpa)){
        # load raw metaphlan data
        mpa <- data.table::fread(mpa,skip = 1) %>%
          as.data.frame()
      }
    }
  # find for each row, to which depth of taxonomy it arrives (as integers)
  tax_lengths <- mpa$clade_name %>%
    strsplit("|", fixed = T) %>%
    sapply(length)
  # remove first element,we want to keep it
  tax_lengths <- tax_lengths[-1]
  # get integer equivalent of the taxonomic level we want
  tax_lvl_int <- match(tax_lvl, c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "SGB"))
  # subset the otu table, so to keep only UNASSIGNED on top and the rows exactly to te taxonomic level
  otu_cleaned <- mpa[c(T, tax_lengths == tax_lvl_int), 2:ncol(mpa)]

  if(!is.null(metadata)){
    inters_names <- intersect(colnames(otu_cleaned), rownames(metadata))
    if(verbose){
      if(length(colnames(otu_cleaned)[!(colnames(otu_cleaned) %in% inters_names)])!= 0){
        cat("Metaphlan table samples lost: ")
        cat(colnames(otu_cleaned)[!(colnames(otu_cleaned) %in% inters_names)], sep = " ")
        cat("\n")
        cat("\n")
      }

      if(length(rownames(metadata)[!(rownames(metadata) %in% inters_names)]) != 0){
        cat("Metadata table samples lost: ")
        cat(rownames(metadata)[!(rownames(metadata) %in% inters_names)], sep = " ")
        cat("\n")
        cat("\n")
      }
    }

    otu_cleaned <- otu_cleaned[, inters_names]
    metadata_cleaned <- metadata[match(inters_names, rownames(metadata)),]

  }

  # create taxonomy table, filling empty columns with NA

  taxonomy_tab <- mpa[c(T, tax_lengths == tax_lvl_int), 1] %>%
    as.data.frame() %>%
    set_names("clade_name") %>%
    separate(col="clade_name", into = c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "SGB")[1:tax_lvl_int],sep = "\\|", fill = "right") %>%
    as.matrix()
  # rename the UNKNOWN clade as all unknown, otherwise we can't assign rownames
  taxonomy_tab[1,] <- rep("UNKNOWN",tax_lvl_int)

  #assign rownames to the tax level chosen
  rownames(taxonomy_tab) <- paste0("otu", seq_len(nrow(otu_cleaned)))
  rownames(otu_cleaned) <- rownames(taxonomy_tab)
  


    profiles <- phyloseq(otu_table(as.matrix(otu_cleaned), taxa_are_rows = TRUE),
                         tax_table(taxonomy_tab),
                         sample_data(metadata_cleaned, errorIfNULL = FALSE)
    )

    return(profiles)
}
```


* Load data
```{r}
#load metadata and reassign column 1 as rownames
metadata <- read_csv("Metadata_6189_Batch2_250724.csv") %>% 
  remove_rownames %>% 
  column_to_rownames(var =  "sample")

mpa_withunknown <- read_tsv("6189_merged_ab.txt", skip=1)
```

## Colour palette
```{r}
cb_palette <- c("#ee8866", "#77aadd","#d3d3d3","#FDF28E","#8ED29B","#bbccee", "#AFC30A","#cc99cc","#C1E49C","#dd7788", "#009E73")
```



# Community Composition

## Kingdom level

* Parse metaphlan data into phyloseq object
```{r}
kingdom_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Kingdom"
)
```

```{r}
kingdom_physeq <- kingdom_physeq %>% tax_fix()
```

* Remove the leading characters (e.g. p__)
```{r}
# view part of the tax table
phyloseq::tax_table(kingdom_physeq)

# replace _[A-Z] with ""
tax_table(kingdom_physeq)[, colnames(tax_table(kingdom_physeq))] <- gsub(tax_table(kingdom_physeq)[, colnames(tax_table(kingdom_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(kingdom_physeq)
```

```{r}
# Filter kingdom level phyloseq object to remove Eukaryotes
kingdom_physeq <- subset_taxa(kingdom_physeq, Kingdom!="Eukaryota")
```

* Kingdom level
```{r}
#TopNOTUs.King <- names(sort(taxa_sums(kingdom_physeq), TRUE)[1:10])
#king10   <- prune_taxa(TopNOTUs.King, kingdom_physeq)
# prune "empty" samples
king10 <- prune_samples(sample_sums(kingdom_physeq) > 0, kingdom_physeq)
plot_bar(king10, fill="Kingdom")
```

## Faceted bar chart - Kingdom
- ID is age-ranked
```{r}
# melt into df
king10.df <- psmelt(king10)

# remove underscores between words in Phylum column
king10.df$Kingdom <- gsub("_", " ", king10.df$Kingdom)

# make region a factor in the df (i.e. change order of facets in next step)
king10.df$type <- factor(king10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
king10.df <- king10.df[order(king10.df$age, king10.df$id), ]
king10.df$id <- factor(king10.df$id, levels = unique(king10.df$id))

# plot
king_plot <- ggplot(king10.df, aes(x = id, y = Abundance, fill = Kingdom)) +
  theme_light() +
  geom_col() +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=20, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=20),
        axis.title.x = element_text(size = 24, color = "black"),
        axis.title.y = element_text(size = 24, color = "black"),
        axis.title = element_text(size = 20, color = "black"),
        plot.title = element_text(face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 18, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=24),
        legend.title = element_text(size=26),
        legend.position = "right") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
king_plot

# Make agegroup a factor in the df
king10.df$agegroup <- factor(king10.df$agegroup, levels=c("Young", "Adult", "Aged"))

# Create the age group annotations plot
king_age_group_annotations <- ggplot(king10.df, aes(x = id, fill = agegroup)) +
  geom_tile(aes(y = -5, height = 3)) +  # Adjust height to fit beneath the main plot
  scale_fill_manual(values = c("#f4e285", "#f4a259", "#8cb369")) +  # Customize colors as needed
  facet_grid(~ type, space = "free", scales = "free") +
  theme_void() +
  theme(legend.position = "bottom",
        strip.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        panel.spacing = unit(0.25, "lines"),
        legend.title = element_text(size = 26),
        legend.text = element_text(size = 24)) +
  guides(fill=guide_legend(title="Age Group"))

# Combine the two plots using patchwork
king_combined_plot <- king_plot / king_age_group_annotations + plot_layout(heights = c(10, 1))
king_combined_plot
```

* Save as 300 dpi tiff
```{r}
# Save the bar plot
tiff(file.path(folder_path, "Kingdom_RelAb.tiff"), units="in", width=22, height=11, res=300)
plot(king_combined_plot)
dev.off()
```

# Bacteria

## Phylum level

* Parse metaphlan data into phyloseq object
```{r}
meta_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Phylum"
)
```

* Clean taxonomy table

Next we will fill in any missing taxonomic information, using a function from the package microViz. This is especially apparent in the Species rank, where many entries appear to be missing. This would cause problems if we try to aggregate at different levels, so we will use tax_fix to fill in these values with those from the next higher taxonomic rank. 
```{r}
meta_physeq <- meta_physeq %>% tax_fix()
```

* Remove the leading characters (e.g. p__)
```{r}
# view part of the tax table
phyloseq::tax_table(meta_physeq)[1:10, 1:2]

# replace _[A-Z] with ""
tax_table(meta_physeq)[, colnames(tax_table(meta_physeq))] <- gsub(tax_table(meta_physeq)[, colnames(tax_table(meta_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(meta_physeq)[1:10, 1:2]
```

* Filter so only bacteria are included
```{r}
# Filter phylum level phyloseq object to remove Eukaryotes
meta_physeq <- subset_taxa(meta_physeq, Kingdom!="Eukaryota" & Kingdom!="Archaea")
```

* Phylum level
```{r}
TopNOTUs.Phy <- names(sort(taxa_sums(meta_physeq), TRUE)[2:11])
phy10   <- prune_taxa(TopNOTUs.Phy, meta_physeq)
plot_bar(phy10, fill="Phylum")
```

## Faceted bar chart - Phyla
- ID is age-ranked
```{r}
# melt into df
phy10.df <- psmelt(phy10)

# remove underscores between words in Phylum column
phy10.df$Phylum <- gsub("_", " ", phy10.df$Phylum)

# make region a factor in the df (i.e. change order of facets in next step)
phy10.df$type <- factor(phy10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "J", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
phy10.df <- phy10.df[order(phy10.df$age, phy10.df$id), ]
phy10.df$id <- factor(phy10.df$id, levels = unique(phy10.df$id))

# plot
phy_plot <- ggplot(phy10.df, aes(x = id, y = Abundance, fill = Phylum)) +
  theme_light() +
  geom_col() +
  ggtitle("Phylum") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) +
#  scale_fill_grafify(palette = "light") +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
phy_plot

```

* Export as 300DPI TIFF
```{r}
tiff(file.path(folder_path, "Phylum_RelAb.tiff"), units="in", width=18, height=9.5, res=300)
plot(phy_plot)
dev.off()
```



# Class

* Parse metaphlan data into phyloseq object
```{r}
class_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Class"
)
```

* Clean table
```{r}
class_physeq <- class_physeq %>% tax_fix()
```

* Remove the leading characters (e.g. p__)
```{r}
# view part of the tax table
phyloseq::tax_table(class_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(class_physeq)[, colnames(tax_table(class_physeq))] <- gsub(tax_table(class_physeq)[, colnames(tax_table(class_physeq))],     pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(class_physeq)[1:10, 1:2]
```

* Filter so only bacteria are included
```{r}
# Filter phylum level phyloseq object to remove Eukaryotes
class_physeq <- subset_taxa(class_physeq, Kingdom!="Eukaryota" & Kingdom!="Archaea")
```

* Class level
```{r}
TopNOTUs.Class <- names(sort(taxa_sums(class_physeq), TRUE)[2:11])
class10   <- prune_taxa(TopNOTUs.Class, class_physeq)
plot_bar(class10, fill="Class")
```


## Class Rel. Ab

* Faceted bar chart - Class
- ID is age-ranked
```{r}
# melt into df
class10.df <- psmelt(class10)

# remove underscores between words in Class column
class10.df$Class <- gsub("_", " ", class10.df$Class)

# make region a factor in the df (i.e. change order of facets in next step)
class10.df$type <- factor(class10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "J", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
class10.df <- class10.df[order(class10.df$age, class10.df$id), ]
class10.df$id <- factor(class10.df$id, levels = unique(class10.df$id))

# Order the 'order' factor levels so that UNKNOWN is last
class10.df$Class <- factor(class10.df$Class, levels = c(sort(unique(class10.df$Class[class10.df$Class != 'UNKNOWN'])), 'UNKNOWN'))

# plot
class_plot <- ggplot(class10.df, aes(x = id, y = Abundance, fill = Class)) +
  theme_light() +
  geom_col() +
  ggtitle("Class") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
   scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
class_plot
```

* Export as 300DPI TIFF
```{r}
tiff(file.path(folder_path, "Class_RelAb.tiff"), units="in", width=18, height=9.5, res=300)
plot(class_plot)
dev.off()
```



# Order

* Parse metaphlan data into phyloseq object
```{r}
order_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Order"
)
```

* Clean table
```{r}
order_physeq <- order_physeq %>% tax_fix()
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(order_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(order_physeq)[, colnames(tax_table(order_physeq))] <- gsub(tax_table(order_physeq)[, colnames(tax_table(order_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(order_physeq)[1:10]
```

* Filter so only bacteria are included
```{r}
# Filter phylum level phyloseq object to remove Eukaryotes
order_physeq <- subset_taxa(order_physeq, Kingdom!="Eukaryota" & Kingdom!="Archaea")
```

* Order level
```{r}
TopNOTUs.Order <- names(sort(taxa_sums(order_physeq), TRUE)[2:11])
order10   <- prune_taxa(TopNOTUs.Order, order_physeq)
plot_bar(order10, fill="Order")
```

## Order Rel. Abundance

```{r}
# melt into df
order10.df <- psmelt(order10)

# remove underscores between words in Order column
order10.df$Order <- gsub("_", " ", order10.df$Order)

# make region a factor in the df (i.e. change order of facets in next step)
order10.df$type <- factor(order10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "J", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
order10.df <- order10.df[order(order10.df$age, order10.df$id), ]
order10.df$id <- factor(order10.df$id, levels = unique(order10.df$id))

# Order the 'order' factor levels so that UNKNOWN is last
order10.df$Order <- factor(order10.df$Order, levels = c(sort(unique(order10.df$Order[order10.df$Order != 'UNKNOWN'])), 'UNKNOWN'))

# plot
order_plot <- ggplot(order10.df, aes(x = id, y = Abundance, fill = Order)) +
  theme_light() +
  geom_col() +
  ggtitle("Order") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
order_plot

# Make agegroup a factor in the df
order10.df$agegroup <- factor(order10.df$agegroup, levels=c("Young", "Adult", "Aged"))

# Create the age group annotations plot
ord_age_group_annotations <- ggplot(order10.df, aes(x = id, fill = agegroup)) +
  geom_tile(aes(y = -5, height = 3)) +  # Adjust height to fit beneath the main plot
  scale_fill_manual(values = c("#f4e285", "#f4a259", "#8cb369")) +  # Customize colors as needed
  facet_grid(~ type, space = "free", scales = "free") +
  theme_void() +
  theme(legend.position = "bottom",
        strip.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        panel.spacing = unit(0.25, "lines"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) +
  guides(fill=guide_legend(title="Age Group"))

# Combine the two plots using patchwork
order_combined_plot <- order_plot / ord_age_group_annotations + plot_layout(heights = c(10, 1))
order_combined_plot
```

* Export at 300 dpi
```{r}
tiff(file.path(folder_path, "Order_RelAb.tiff"), units="in", width=18, height=9.5, res=300)
plot(order_plot)
dev.off()
```


# Patchwork plot - Bacterial Phyla/Class/Order

* Create patchwork and export
```{r}
GIT_Tax1 <- phy_plot / class_plot / order_plot + ord_age_group_annotations +
  plot_layout(heights = c(10, 10, 10, 1))
GIT_Tax1

tiff(file.path(tolder_path, "GIT_Tax1.tiff"), units="in", width=8.27, height=13, res=300)
plot(GIT_Tax1)
dev.off()
```


# Family

* Parse metaphlan data into phyloseq object
```{r}
family_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Family"
)
```

* Clean table
```{r}
family_physeq <- family_physeq %>% tax_fix()
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(family_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(family_physeq)[, colnames(tax_table(family_physeq))] <- gsub(tax_table(family_physeq)[, colnames(tax_table(family_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(family_physeq)[1:10]
```

* Filter so only bacteria are included
```{r}
# Filter phylum level phyloseq object to remove Eukaryotes
family_physeq <- subset_taxa(family_physeq, Kingdom!="Eukaryota" & Kingdom!="Archaea")
```

* Family level
```{r}
TopNOTUs.Family <- names(sort(taxa_sums(family_physeq), TRUE)[2:11])
family10   <- prune_taxa(TopNOTUs.Family, family_physeq)
plot_bar(family10, fill="Family")
```

## Family Rel. Abundance
```{r}
# melt into df
family10.df <- psmelt(family10)

# remove underscores between words in Family column
family10.df$Family <- gsub("_", " ", family10.df$Family)

# make region a factor in the df (i.e. change order of facets in next step)
family10.df$type <- factor(family10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "J", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
family10.df <- family10.df[order(family10.df$age, family10.df$id), ]
family10.df$id <- factor(family10.df$id, levels = unique(family10.df$id))

# Order the 'Family' factor levels so that UNKNOWN is last
family10.df$Family <- factor(family10.df$Family, levels = c(sort(unique(family10.df$Family[family10.df$Family != 'UNKNOWN'])), 'UNKNOWN'))

# plot
family_plot <- ggplot(family10.df, aes(x = id, y = Abundance, fill = Family)) +
  theme_light() +
  geom_col() +
  ggtitle("Family") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=9),
        legend.title = element_text(size=11),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
family_plot
```


* Export at 300 dpi
```{r}
tiff(file.path(folder_path, "Family_RelAb.tiff"), units="in", width=18, height=9.5, res=300)
plot(family_plot)
dev.off()
```


# Genus

* Parse metaphlan data into phyloseq object
```{r}
genus_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Genus"
)
```

* Clean table
```{r}
genus_physeq <- genus_physeq %>% tax_fix()
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(genus_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(genus_physeq)[, colnames(tax_table(genus_physeq))] <- gsub(tax_table(genus_physeq)[, colnames(tax_table(genus_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(genus_physeq)[1:10]
```

* Filter so only bacteria are included
```{r}
# Filter phylum level phyloseq object to remove Eukaryotes
genus_physeq <- subset_taxa(genus_physeq, Kingdom!="Eukaryota" & Kingdom!="Archaea")
```

* Genus level
```{r}
TopNOTUs.Genus <- names(sort(taxa_sums(genus_physeq), TRUE)[2:11])
genus10   <- prune_taxa(TopNOTUs.Genus, genus_physeq)
plot_bar(genus10, fill="Genus")
```

## Genus Rel. Abundance
```{r}
# melt into df
genus10.df <- psmelt(genus10)

# remove underscores between words in Genus column
genus10.df$Genus <- gsub("_", " ", genus10.df$Genus)

# make region a factor in the df (i.e. change order of facets in next step)
genus10.df$type <- factor(genus10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "J", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
genus10.df <- genus10.df[order(genus10.df$age, genus10.df$id), ]
genus10.df$id <- factor(genus10.df$id, levels = unique(genus10.df$id))

# Order the 'Genus' factor levels so that UNKNOWN is last
genus10.df$Genus <- factor(genus10.df$Genus, levels = c(sort(unique(genus10.df$Genus[genus10.df$Genus != 'UNKNOWN'])), 'UNKNOWN'))

# plot
genus_plot <- ggplot(genus10.df, aes(x = id, y = Abundance, fill = Genus)) +
  theme_light() +
  geom_col() +
  ggtitle("Genus") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
    scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
genus_plot
```


* Save as 300 dpi tiff
```{r}
tiff(file.path(folder_path, "Genus_RelAb.tiff"), units="in", width=18, height=9.5, res=300)
plot(genus_plot)
dev.off()
```


# Species

* Parse metaphlan data into phyloseq object
```{r}
species_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Species"
)
```

* Clean table
```{r}
species_physeq <- species_physeq %>% tax_fix()
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(species_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(species_physeq)[, colnames(tax_table(species_physeq))] <- gsub(tax_table(species_physeq)[, colnames(tax_table(species_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(species_physeq)[1:10]
```

* Filter so only bacteria are included
```{r}
# Filter phylum level phyloseq object to remove Eukaryotes
species_physeq <- subset_taxa(species_physeq, Kingdom!="Eukaryota" & Kingdom!="Archaea")
```

* Export phyloseq object for other scripts 
```{r}
saveRDS(species_physeq, file = "species_phyloseq.rds")
```

* Get unique counts
```{r}
# find number of unique species
species_all <- psmelt(species_physeq)
unique_counts_sp <- sapply(species_all, n_distinct)
unique_counts_sp
```

* Species level
```{r}
TopNOTUs.Species <- names(sort(taxa_sums(species_physeq), TRUE)[2:11])
species10   <- prune_taxa(TopNOTUs.Species, species_physeq)
plot_bar(species10, fill="Species")
```

## Species Rel. Abundance
```{r}
# melt into df
species10.df <- psmelt(species10)

# remove underscores between words in Species column
species10.df$Species <- gsub("_", " ", species10.df$Species)

# make region a factor in the df (i.e. change order of facets in next step)
species10.df$type <- factor(species10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "J", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
species10.df <- species10.df[order(species10.df$age, species10.df$id), ]
species10.df$id <- factor(species10.df$id, levels = unique(species10.df$id))

# Order the 'Species' factor levels so that UNKNOWN is last
species10.df$Species <- factor(species10.df$Species, levels = c(sort(unique(species10.df$Species[species10.df$Species != 'UNKNOWN'])), 'UNKNOWN'))

# plot
species_plot <- ggplot(species10.df, aes(x = id, y = Abundance, fill = Species)) +
  theme_light() +
  geom_col() +
  ggtitle("Species") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=9),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 3)) +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
species_plot

# Make agegroup a factor in the df
species10.df$agegroup <- factor(species10.df$agegroup, levels=c("Young", "Adult", "Aged"))

# Create the age group annotations plot
sp_age_group_annotations <- ggplot(species10.df, aes(x = id, fill = agegroup)) +
  geom_tile(aes(y = -5, height = 3)) +  # Adjust height to fit beneath the main plot
  scale_fill_manual(values = c("#f4e285", "#f4a259", "#8cb369")) +  # Customize colors as needed
  facet_grid(~ type, space = "free", scales = "free") +
  theme_void() +
  theme(legend.position = "bottom",
        strip.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        panel.spacing = unit(0.25, "lines"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) +
  guides(fill=guide_legend(title="Age Group"))

# Combine the two plots using patchwork
sp_combined_plot <- species_plot / sp_age_group_annotations + plot_layout(heights = c(10, 1))
sp_combined_plot
```


* Save as 300 dpi tiff
```{r}
tiff(file.path(folder_path, "Species_RelAb.tiff"), units="in", width=18, height=9.5, res=300)
plot(species_plot)
dev.off()
```


# Second Patchwork Plot - Bacteria

* Create patchwork and export
```{r}
GIT_Tax2 <- family_plot / genus_plot / species_plot + sp_age_group_annotations + plot_layout(heights = c(10, 10, 10, 1))
GIT_Tax2

tiff(file.path(folder_path, "GIT_Tax2.tiff"), units="in", width=8.27, height=13, res=300)
plot(GIT_Tax2)
dev.off()
```

## Segatella sp.

* Filter so only Segatella sp are included
```{r}
# Filter phylum level phyloseq object to remove Eukaryotes
species_physeq.seg <- subset_taxa(species_physeq, Genus=="Segatella")

plot_bar(species_physeq.seg, fill="Species")
```

```{r}
# melt into df
species.seg.df <- psmelt(species_physeq.seg)

# remove underscores between words in Species column
species.seg.df$Species <- gsub("_", " ", species.seg.df$Species)

# make region a factor in the df (i.e. change order of facets in next step)
species.seg.df$type <- factor(species.seg.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "J", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
species.seg.df <- species.seg.df[order(species.seg.df$age, species.seg.df$id), ]
species.seg.df$id <- factor(species.seg.df$id, levels = unique(species.seg.df$id))

# Order the 'Species' factor levels so that UNKNOWN is last
species.seg.df$Species <- factor(species.seg.df$Species, levels = c(sort(unique(species.seg.df$Species[species.seg.df$Species != 'UNKNOWN'])), 'UNKNOWN'))


# find number of unique species
unique_counts_seg <- sapply(species.seg.df, n_distinct)
unique_counts_seg

species.seg.df <- filter(species.seg.df, Abundance > 0.1)

# plot
seg.species_plot <- ggplot(species.seg.df, aes(x = id, y = Abundance, fill = Species)) +
  theme_light() +
  geom_col() +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=18, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=20),
        axis.title.x = element_text(size = 24, color = "black"),
        axis.title.y = element_text(size = 24, color = "black"),
        axis.title = element_text(size = 20, color = "black"),
        plot.title = element_text(face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 18, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=24),
        legend.title = element_text(size=26),
        legend.position = "right") +
  scale_fill_manual(values = cb_palette) +
  xlab("Sample ID") + ylab("Relative Abundance (%)")
seg.species_plot

# Make agegroup a factor in the df
species.seg.df$agegroup <- factor(species.seg.df$agegroup, levels=c("Young", "Adult", "Aged"))

# Create the age group annotations plot
seg_age_group_annotations <- ggplot(species.seg.df, aes(x = id, fill = agegroup)) +
  geom_tile(aes(y = -5, height = 3)) +  # Adjust height to fit beneath the main plot
  scale_fill_manual(values = c("#f4e285", "#f4a259", "#8cb369")) +  # Customize colors as needed
  facet_grid(~ type, space = "free", scales = "free") +
  theme_void() +
  theme(legend.position = "bottom",
        strip.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        panel.spacing = unit(0.25, "lines"),
        legend.title = element_text(size = 26),
        legend.text = element_text(size = 24)) +
  guides(fill=guide_legend(title="Age Group"))

# Combine the two plots using patchwork
seg_combined_plot <- seg.species_plot / seg_age_group_annotations + plot_layout(heights = c(10, 1))
seg_combined_plot
```

* Save as 300 dpi tiff
```{r}
tiff(file.path(folder_path, "SegatellaSpecies_RelAb.tiff"), units="in", width=20, height=9.5, res=300)
plot(seg_combined_plot)
dev.off()
```



# Archaea

* Parse metaphlan data into phyloseq object
```{r}
arch.phy_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Phylum"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.phy_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.phy_physeq)[, colnames(tax_table(arch.phy_physeq))] <- gsub(tax_table(arch.phy_physeq)[, colnames(tax_table(arch.phy_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.phy_physeq)[1:10]
```

## Archaea Phylum
```{r}
# Filter phylum level phyloseq object according to Archaea
PHYL.arch = subset_taxa(arch.phy_physeq, Kingdom=="Archaea")
```

* Find top 10 OTUs
```{r}
TopNOTUs.Arch.Phylum <- names(sort(taxa_sums(PHYL.arch), TRUE)[1:10])
arch.phylum10   <- prune_taxa(TopNOTUs.Arch.Phylum, PHYL.arch)
# prune "empty" samples
arch.phylum10 <- prune_samples(sample_sums(arch.phylum10) > 0.1, arch.phylum10)
# plot bar
plot_bar(arch.phylum10, fill="Phylum")
```

## Archaea Phylum Rel. Abundance
```{r}
# melt into df
arch.phylum10.df <- psmelt(arch.phylum10)

# remove underscores between words in Phylum column
arch.phylum10.df$Phylum <- gsub("_", " ", arch.phylum10.df$Phylum)

# make region a factor in the df (i.e. change order of facets in next step)
arch.phylum10.df$type <- factor(arch.phylum10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.phylum10.df <- arch.phylum10.df[order(arch.phylum10.df$age, arch.phylum10.df$id), ]
arch.phylum10.df$id <- factor(arch.phylum10.df$id, levels = unique(arch.phylum10.df$id))

# Order the 'Phylum' factor levels so that UNKNOWN is last
arch.phylum10.df$Phylum <- factor(arch.phylum10.df$Phylum, levels = c(sort(unique(arch.phylum10.df$Phylum[arch.phylum10.df$Phylum != 'UNKNOWN'])), 'UNKNOWN'))

# plot
arch.phylum_plot <- ggplot(arch.phylum10.df, aes(x = id, y = Abundance, fill = Phylum)) +
  theme_light() +
  geom_col() +
  ggtitle("Phylum") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.phylum_plot
```


* Save as 300 dpi tiff
```{r}
tiff(file.path(folder_path, "Arch_Phylum_RelAb.tiff"), units="in", width=14, height=9.5, res=300)
plot(arch.phylum_plot)
dev.off()
```


## Archaea Class

* Parse metaphlan data into phyloseq object
```{r}
arch.class_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Class"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.class_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.class_physeq)[, colnames(tax_table(arch.class_physeq))] <- gsub(tax_table(arch.class_physeq)[, colnames(tax_table(arch.class_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.class_physeq)[1:10]
```

```{r}
# Filter class level phyloseq object according to Archaea
CLASS.arch = subset_taxa(arch.class_physeq, Kingdom=="Archaea")
```

* Find top 10 OTUs
```{r}
TopNOTUs.Arch.Class <- names(sort(taxa_sums(CLASS.arch), TRUE)[1:10])
arch.class10   <- prune_taxa(TopNOTUs.Arch.Class, CLASS.arch)
# prune "empty" samples
arch.class10 <- prune_samples(sample_sums(arch.class10) > 0.1, arch.class10)
# plot bar
plot_bar(arch.class10, fill="Class")
```

## Archaea Class Rel. Abundance
```{r}
# melt into df
arch.class10.df <- psmelt(arch.class10)

# remove underscores between words in Class column
arch.class10.df$Class <- gsub("_", " ", arch.class10.df$Class)

# make region a factor in the df (i.e. change order of facets in next step)
arch.class10.df$type <- factor(arch.class10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.class10.df <- arch.class10.df[order(arch.class10.df$age, arch.class10.df$id), ]
arch.class10.df$id <- factor(arch.class10.df$id, levels = unique(arch.class10.df$id))

# Order the 'Class' factor levels so that UNKNOWN is last
arch.class10.df$Class <- factor(arch.class10.df$Class, levels = c(sort(unique(arch.class10.df$Class[arch.class10.df$Class != 'UNKNOWN'])), 'UNKNOWN'))

# plot
arch.class_plot <- ggplot(arch.class10.df, aes(x = id, y = Abundance, fill = Class)) +
  theme_light() +
  geom_col() +
  ggtitle("Class") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.class_plot
```

* Save as 300 dpi tiff
```{r}
tiff(file.path(folder_path, "Arch_Class_RelAb.tiff"), units="in", width=14, height=9.5, res=300)
plot(arch.class_plot)
dev.off()
```


## Archaea Order

* Parse metaphlan data into phyloseq object
```{r}
arch.order_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Order"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.order_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.order_physeq)[, colnames(tax_table(arch.order_physeq))] <- gsub(tax_table(arch.order_physeq)[, colnames(tax_table(arch.order_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.order_physeq)[1:10]
```

```{r}
# Filter order level phyloseq object according to Archaea
ORD.arch = subset_taxa(arch.order_physeq, Kingdom=="Archaea")
```

```{r}
TopNOTUs.Arch.Order <- names(sort(taxa_sums(ORD.arch), TRUE)[1:10])
arch.order10   <- prune_taxa(TopNOTUs.Arch.Order, ORD.arch)
# prune "empty" samples
arch.order10 <- prune_samples(sample_sums(arch.order10) > 0.1, arch.order10)
# plot bar
plot_bar(arch.order10, fill="Order")
```

## Archaea Order Rel. Abundance
```{r}
# melt into df
arch.order10.df <- psmelt(arch.order10)

# remove underscores between words in Order column
arch.order10.df$Order <- gsub("_", " ", arch.order10.df$Order)

# make region a factor in the df (i.e. change order of facets in next step)
arch.order10.df$type <- factor(arch.order10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.order10.df <- arch.order10.df[order(arch.order10.df$age, arch.order10.df$id), ]
arch.order10.df$id <- factor(arch.order10.df$id, levels = unique(arch.order10.df$id))

# Order the 'Order' factor levels so that UNKNOWN is last
arch.order10.df$Order <- factor(arch.order10.df$Order, levels = c(sort(unique(arch.order10.df$Order[arch.order10.df$Order != 'UNKNOWN'])), 'UNKNOWN'))

# plot
arch.order_plot <- ggplot(arch.order10.df, aes(x = id, y = Abundance, fill = Order)) +
  theme_light() +
  geom_col() +
  ggtitle("Order") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.order_plot

# Make agegroup a factor in the df
arch.order10.df$agegroup <- factor(arch.order10.df$agegroup, levels=c("Young", "Adult", "Aged"))

# Create the age group annotations plot
arch.ord_age_group_annotations <- ggplot(arch.order10.df, aes(x = id, fill = agegroup)) +
  geom_tile(aes(y = -5, height = 3)) +  # Adjust height to fit beneath the main plot
  scale_fill_manual(values = c("#f4e285", "#f4a259", "#8cb369")) +  # Customize colors as needed
  facet_grid(~ type, space = "free", scales = "free") +
  theme_void() +
  theme(legend.position = "bottom",
        strip.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        panel.spacing = unit(0.25, "lines"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) +
  guides(fill=guide_legend(title="Age Group"))

# Combine the two plots using patchwork
arch.ord_combined_plot <- arch.order_plot / arch.ord_age_group_annotations + plot_layout(heights = c(10, 1))
arch.ord_combined_plot
```

* Save as 300 dpi tiff
```{r}
tiff(file.path(folder_path, "Arch_Order_RelAb.tiff"), units="in", width=14, height=9.5, res=300)
plot(arch.order_plot)
dev.off()
```

##Archaea Patchwork Plot 1
* Create patchwork and export
```{r}
GIT_Arch_Tax1 <- arch.phylum_plot / arch.class_plot / arch.order_plot / arch.ord_age_group_annotations + plot_layout(heights = c(10,10,10,1))
GIT_Arch_Tax1

tiff(file.path(folder_path, "GIT_Arch_Tax1.tiff"), units="in", width=8.27, height=13, res=300)
plot(GIT_Arch_Tax1)
dev.off()
```

## Archaea Family

* Parse metaphlan data into phyloseq object
```{r}
arch.family_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Family"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.family_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.family_physeq)[, colnames(tax_table(arch.family_physeq))] <- gsub(tax_table(arch.family_physeq)[, colnames(tax_table(arch.family_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.family_physeq)[1:10]
```

```{r}
# Filter family level phyloseq object according to Archaea
FAM.arch = subset_taxa(arch.family_physeq, Kingdom=="Archaea")
```

* Top 10 OTUs
```{r}
TopNOTUs.Arch.Family <- names(sort(taxa_sums(FAM.arch), TRUE)[1:10])
arch.family10   <- prune_taxa(TopNOTUs.Arch.Family, FAM.arch)
# prune "empty" samples
arch.family10 <- prune_samples(sample_sums(arch.family10) > 0.1, arch.family10)
# plot bar
plot_bar(arch.family10, fill="Family")
```

## Archaea Family Rel. Abundance
```{r}
# melt into df
arch.family10.df <- psmelt(arch.family10)

# remove underscores between words in Family column
arch.family10.df$Family <- gsub("_", " ", arch.family10.df$Family)

# make region a factor in the df (i.e. change order of facets in next step)
arch.family10.df$type <- factor(arch.family10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.family10.df <- arch.family10.df[order(arch.family10.df$age, arch.family10.df$id), ]
arch.family10.df$id <- factor(arch.family10.df$id, levels = unique(arch.family10.df$id))

# Order the 'Family' factor levels so that UNKNOWN is last
arch.family10.df$Family <- factor(arch.family10.df$Family, levels = c(sort(unique(arch.family10.df$Family[arch.family10.df$Family != 'UNKNOWN'])), 'UNKNOWN'))

# plot
arch.family_plot <- ggplot(arch.family10.df, aes(x = id, y = Abundance, fill = Family)) +
  theme_light() +
  geom_col() +
  ggtitle("Family") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.family_plot
```

* Save as 300 dpi tiff
```{r}
tiff(file.path(folder_path, "Arch_Family_RelAb.tiff"), units="in", width=14, height=9.5, res=300)
plot(arch.family_plot)
dev.off()
```

## Archaea Genus 

* Parse metaphlan data into phyloseq object
```{r}
arch.genus_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Genus"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.genus_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.genus_physeq)[, colnames(tax_table(arch.genus_physeq))] <- gsub(tax_table(arch.genus_physeq)[, colnames(tax_table(arch.genus_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.genus_physeq)[1:10]
```

* Genus level -  Archaea
```{r}
# Filter genus level phyloseq object according to Archaea
GEN.arch = subset_taxa(arch.genus_physeq, Kingdom=="Archaea")
```

* Top 10 OTUs
```{r}
TopNOTUs.Arch.Genus <- names(sort(taxa_sums(GEN.arch), TRUE)[1:10])
arch.genus10   <- prune_taxa(TopNOTUs.Arch.Genus, GEN.arch)
# prune "empty" samples
arch.genus10 <- prune_samples(sample_sums(arch.genus10) > 0.1, arch.genus10)
# plot bar
plot_bar(arch.genus10, fill="Genus")
```

## Archaea Genus Rel. Abundance
```{r}
# melt into df
arch.genus10.df <- psmelt(arch.genus10)

# remove underscores between words in Genus column
arch.genus10.df$Genus <- gsub("_", " ", arch.genus10.df$Genus)

# make region a factor in the df (i.e. change order of facets in next step)
arch.genus10.df$type <- factor(arch.genus10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.genus10.df <- arch.genus10.df[order(arch.genus10.df$age, arch.genus10.df$id), ]
arch.genus10.df$id <- factor(arch.genus10.df$id, levels = unique(arch.genus10.df$id))

# Order the 'Genus' factor levels so that UNKNOWN is last
arch.genus10.df$Genus <- factor(arch.genus10.df$Genus, levels = c(sort(unique(arch.genus10.df$Genus[arch.genus10.df$Genus != 'UNKNOWN'])), 'UNKNOWN'))

# plot
arch.genus_plot <- ggplot(arch.genus10.df, aes(x = id, y = Abundance, fill = Genus)) +
  theme_light() +
  geom_col() +
  ggtitle("Genus") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=10),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.genus_plot
```

* Save as 300 dpi tiff
```{r}
tiff(file.path(folder_path, "Arch_Genus_RelAb.tiff"), units="in", width=14, height=9.5, res=300)
plot(arch.genus_plot)
dev.off()
```

# Archaea Species 

* Parse metaphlan data into phyloseq object
```{r}
arch.species_physeq <- metaphlan_to_phyloseq(
  mpa_withunknown,
  metadata = metadata,
  version = 4,
  verbose = TRUE,
  tax_lvl = "Species"
)
```

* Remove leading characters
```{r}
# view part of the tax table
phyloseq::tax_table(arch.species_physeq)[1:10]

# replace _[A-Z] with ""
tax_table(arch.species_physeq)[, colnames(tax_table(arch.species_physeq))] <- gsub(tax_table(arch.species_physeq)[, colnames(tax_table(arch.species_physeq))], pattern = "[a-z]__", replacement = "")

# check tax_table again
phyloseq::tax_table(arch.species_physeq)[1:10]
```

* Species level
```{r}
# Filter species level phyloseq object according to Archaea
SP.arch = subset_taxa(arch.species_physeq, Kingdom=="Archaea")
```

* Get unique counts
```{r}
# find number of unique species
arch.species_all <- psmelt(SP.arch)
arch.unique_counts_sp <- sapply(arch.species_all, n_distinct)
arch.unique_counts_sp
```

* Species level - Archaea
```{r}
TopNOTUs.Arch.Species <- names(sort(taxa_sums(SP.arch), TRUE)[1:10])
arch.species10   <- prune_taxa(TopNOTUs.Arch.Species, SP.arch)
# prune "empty" samples
arch.species10 <- prune_samples(sample_sums(arch.species10) > 0.1, arch.species10)
# plot bar
plot_bar(arch.species10, fill="Species")
```

## Archaea Species Rel. Abundance
```{r}
# melt into df
arch.species10.df <- psmelt(arch.species10)

# remove underscores between words in Species column
arch.species10.df$Species <- gsub("_", " ", arch.species10.df$Species)

# make region a factor in the df (i.e. change order of facets in next step)
arch.species10.df$type <- factor(arch.species10.df$type, levels=c("D", "J", "I", "C", "PC", "DC"))

# Label function
labels <- c(D = "Duodenum", J = "Jejunum", I = "Ileum", C = "Caecum", PC = "Proximal Colon", DC = "Distal Colon")

# Order ids by age (using a unique identifier to account for duplicates in df)
arch.species10.df <- arch.species10.df[order(arch.species10.df$age, arch.species10.df$id), ]
arch.species10.df$id <- factor(arch.species10.df$id, levels = unique(arch.species10.df$id))

# Order the 'Species' factor levels so that UNKNOWN is last
arch.species10.df$Species <- factor(arch.species10.df$Species, levels = c(sort(unique(arch.species10.df$Species[arch.species10.df$Species != 'UNKNOWN'])), 'UNKNOWN'))

# plot
arch.species_plot <- ggplot(arch.species10.df, aes(x = id, y = Abundance, fill = Species)) +
  theme_light() +
  geom_col() +
  ggtitle("Species") +
  facet_grid(~ type, space ="free", scales = "free", labeller = labeller(type = labels)) +
  theme(axis.text.x = element_text(angle=90, size=10, hjust=0.95, vjust=0.2), 
        axis.text.y = element_text(size=10),
        axis.title.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black"),
        plot.title = element_text(face = "bold", size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        strip.background =element_rect(fill="grey"),
        strip.text = element_text(size = 12, face = "bold"),  # Adjust the size of facet labels
        legend.text.align = 0, 
        legend.text = element_text(size=8),
        legend.title = element_text(size=12),
        legend.position = "bottom") +
  scale_fill_manual(values = cb_palette) + 
  xlab("Sample ID") + ylab("Relative Abundance (%)")
arch.species_plot


# Make agegroup a factor in the df
arch.species10.df$agegroup <- factor(arch.species10.df$agegroup, levels=c("Young", "Adult", "Aged"))

# Create the age group annotations plot
arch.sp_age_group_annotations <- ggplot(arch.species10.df, aes(x = id, fill = agegroup)) +
  geom_tile(aes(y = -5, height = 3)) +  # Adjust height to fit beneath the main plot
  scale_fill_manual(values = c("#f4e285", "#f4a259", "#8cb369")) +  # Customize colors as needed
  facet_grid(~ type, space = "free", scales = "free") +
  theme_void() +
  theme(legend.position = "bottom",
        strip.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        panel.spacing = unit(0.25, "lines"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) +
  guides(fill=guide_legend(title="Age Group"))

# Combine the two plots using patchwork
arch.sp_combined_plot <- arch.order_plot / arch.sp_age_group_annotations + plot_layout(heights = c(10, 1))
arch.sp_combined_plot
```

* Save as 300 dpi tiff
```{r}
tiff(file.path(folder_path, "Arch_Species_RelAb.tiff"), units="in", width=14, height=9.5, res=300)
plot(arch.species_plot)
dev.off()
```

## Archaea Patchwork Plot 2
* Create patchwork and export
```{r}
GIT_Arch_Tax2 <- arch.family_plot / arch.genus_plot / arch.species_plot/ arch.sp_age_group_annotations + plot_layout(heights = c(10,10,10,1))
GIT_Arch_Tax2

tiff(file.path(folder_path, "GIT_Arch_Tax2.tiff"), units="in", width=8.27, height=13, res=300)
plot(GIT_Arch_Tax2)
dev.off()
```

